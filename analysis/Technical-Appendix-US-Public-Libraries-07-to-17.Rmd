---
title: "Technical Appendix - US Public Library Survey"
author: "Schyuler Lujan"
date: "3/24/2020"
output: html_document
---

# Project Overview

## Project Description

**Expectations**
I expect the following:
- Libraries in rural areas will have larger electronic collections
- Electronic collections to increase over the 10-year period
- Libraries in rural areas will have lower physical circulation but higher electronic circulation

## Description of Data

### Caveats

- Some libraries have data points suppressed to protect confidentiality, so it will be incomplete

Data Source: https://www.imls.gov/research-evaluation/data-collection/public-libraries-survey

# Data Tidying

## Load Libraries

```{r message = FALSE, warning = FALSE}
# Load relevant libraries
library(tidyverse)
library(stringr)
library(janitor)

# Set working directory
#setwd('/Users/Tiny Moo Cow/OneDrive - Seattle University/OMSBA/Other Projects/US-Public-Libraries')
```

## Load Data
```{r message = FALSE, warning = FALSE}
# Load all datasets from 2007 thru 2017
PLS2007 <- read.csv("./pls-data/PLS_2007.csv")
PLS2008 <- read.csv("./pls-data/PLS_2008.csv")
PLS2009 <- read.csv("./pls-data/PLS_2009.csv")
PLS2010 <- read.csv("./pls-data/PLS_2010.csv")
PLS2011 <- read.csv("./pls-data/PLS_2011.csv")
PLS2012 <- read.csv("./pls-data/PLS_2012.csv")
PLS2013 <- read.csv("./pls-data/PLS_2013.csv")
PLS2014 <- read.csv("./pls-data/PLS_2014.csv")
PLS2015 <- read.csv("./pls-data/PLS_2015.csv")
PLS2016 <- read.csv("./pls-data/PLS_2016.csv")
PLS2017 <- read.csv("./pls-data/PLS_2017.csv")
# Add SRVY_YEAR variable to each dataset to track year of survey
PLS2007 <- mutate(PLS2007, SRVY_YEAR = 2007)
PLS2008 <- mutate(PLS2008, SRVY_YEAR = 2008)
PLS2009 <- mutate(PLS2009, SRVY_YEAR = 2009)
PLS2010 <- mutate(PLS2010, SRVY_YEAR = 2010)
PLS2011 <- mutate(PLS2011, SRVY_YEAR = 2011)
PLS2012 <- mutate(PLS2012, SRVY_YEAR = 2012)
PLS2013 <- mutate(PLS2013, SRVY_YEAR = 2013)
PLS2014 <- mutate(PLS2014, SRVY_YEAR = 2014)
PLS2015 <- mutate(PLS2015, SRVY_YEAR = 2015)
PLS2016 <- mutate(PLS2016, SRVY_YEAR = 2016)
PLS2017 <- mutate(PLS2017, SRVY_YEAR = 2017)
# Remove variables beginning with "F_" from all dataframes
PLS2007 <- select(PLS2007, -starts_with("F_"))
PLS2008 <- select(PLS2008, -starts_with("F_"))
PLS2009 <- select(PLS2009, -starts_with("F_"))
PLS2010 <- select(PLS2010, -starts_with("F_"))
PLS2011 <- select(PLS2011, -starts_with("F_"))
PLS2012 <- select(PLS2012, -starts_with("F_"))
PLS2013 <- select(PLS2013, -starts_with("F_"))
PLS2014 <- select(PLS2014, -starts_with("F_"))
PLS2015 <- select(PLS2015, -starts_with("F_"))
PLS2016 <- select(PLS2016, -starts_with("F_"))
PLS2017 <- select(PLS2017, -starts_with("F_"))
```

## Data Merging
```{r}
# Vertical merge of PLS2007 and PLS2008------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS2007, PLS2008, return = c("mismatch"), bind_method = c("rbind"))
# Add new cols and change col type in PLS2007
PLS2007 <- mutate(PLS2007,
                  CNTYPOP = as.integer(NA),
                  LOCALE = as.factor(NA),
                  PHONE = as.factor(PHONE))
# Vertical merge
PLS <- rbind(PLS2007, PLS2008)
# Vertical merge of PLS and PLS2009----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2009, return = c("mismatch"), bind_method = c("rbind"))
# Remove discontinued cols and add new colsfrom PLS
PLS <- select(PLS, -CNTYFIPS, -PUB_FIPS) 
PLS <- mutate(PLS,
              YAATTEN = as.integer(NA),
              YAPRO = as.integer(NA)
              )
# Vertical merge
PLS <- rbind(PLS, PLS2009)
# Vertical merge of PLS and PLS2010----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2010, return = c("mismatch"), bind_method = c("rbind"))
# Rename AUDIO and VIDEO variables in PLS; add new cols; remove discontinued cols
PLS <- rename(PLS,
              AUDIO_PH = AUDIO,
              VIDEO_PH = VIDEO
              )
PLS <- mutate(PLS,
              AUDIO_DL = as.integer(NA),
              VIDEO_DL = as.integer(NA),
              )
PLS <- select(PLS, -ESUBSCRP)
# Vertical merge
PLS <- rbind(PLS, PLS2010)
# Vertical merge of PLS and PLS2011----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2011, return = c("mismatch"), bind_method = c("rbind"))
# Add new cols to PLS
PLS <- mutate(PLS,
              CBSA = as.integer(NA),
              MAT_TYPE = as.integer(NA),
              MICROF = as.factor(NA)
              )
# Change col type in PLS2011
PLS2011 <- mutate(PLS2011, PHONE = as.factor(PHONE))
# Vertical merge
PLS <- rbind(PLS, PLS2011)
# Vertical merge of PLS and PLS2012----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2012, return = c("mismatch"), bind_method = c("rbind"))
# Remove discontinued cols
PLS <- select(PLS, -DB_LOC, -DB_OTH, -MAT_CENT, -MAT_TYPE, -WEB_ADDR)
# Change formats of PLS2012 cols
PLS2012 <- mutate(PLS2012, 
                  CDCODE = as.factor(NA),
                  LOCALE = as.factor(NA))
# Add new cols to PLS
PLS <- mutate(PLS,
              DB_LO_OT = as.integer(NA),
              GAL = as.factor(NA),
              GALMS = as.factor(NA),
              POSTMS = as.factor(NA))
# Vertical merge
PLS <- rbind(PLS, PLS2012)
# Vertical merge of PLS and PLS2013----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2013, return = c("mismatch"), bind_method = c("rbind"))
# Change col types in PLS2013
PLS2013 <- mutate(PLS2013,
                  CDCODE = as.factor(NA),
                  LOCALE = as.factor(NA),
                  MICROF = as.factor(NA),
                  )
# Add new col to PLS
PLS <- mutate(PLS,
              ELMATCIR = as.integer(NA))
# Vertical merge
PLS <- rbind(PLS, PLS2013)
# Vertical merge of PLS and PLS2014----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2014, return = c("mismatch"), bind_method = c("rbind"))
# Convert col types in PLS2014
PLS2014 <- mutate(PLS2014,
                  AUDIO_DL = as.integer(AUDIO_DL),
                  PHONE = as.factor(PHONE),
                  VIDEO_DL = as.integer(VIDEO_DL))
# Add new col to PLS
PLS <- mutate(PLS, WIFISESS = as.integer(NA))
# Vertical merge
PLS <- rbind(PLS, PLS2014)
# Vertical merge of PLS and PLS2015----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2015, return = c("mismatch"), bind_method = c("rbind"))
# Remove discontinued cols in PLS
PLS <- select(PLS, -DATABASE, -DB_LO_OT, -DB_ST, -FIPSCO, -FIPSPLAC, -FIPSST, -GAL, -GALMS, -POSTMS)
# Add new cols
PLS <- mutate(PLS,
              ADDRTYPE = as.factor(NA),
              EC_LO_OT = as.integer(NA),
              EC_ST = as.integer(NA),
              ELECCOLL = as.integer(NA),
              GNISPLAC = as.factor(NA),
              INCITSCO = as.integer(NA),
              INCITSST = as.integer(NA),
              MSTATUS = as.factor(NA),
              SCORE = as.numeric(NA),
              )
# Change col types for PLS2015
PLS2015 <- mutate(PLS2015,
                  CDCODE = as.factor(CDCODE),
                  LOCALE = as.factor(LOCALE),
                  PHONE = as.factor(PHONE))
# Vertical merge
PLS <- rbind(PLS, PLS2015)
# Vertical merge of PLS and PLS2016----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2016, return = c("mismatch"), bind_method = c("rbind"))
# Add new cols to PLS
PLS <- mutate(PLS,
              ELCONT = as.integer(NA),
              ELINFO = as.integer(NA),
              LOCALE_MOD = as.factor(NA),
              PHYSCIR = as.integer(NA),
              REAPLOCALE = as.integer(NA),
              REAPLOCALE_MOD = as.integer(NA),
              TOTCOLL = as.integer(NA)
              )
# Change col type for PLS2016
PLS2016 <- mutate(PLS2016,
                  CDCODE = as.factor(CDCODE),
                  PHONE = as.factor(PHONE))
# Vertical merge
PLS <- rbind(PLS, PLS2016)
# Vertical merge of PLS and PLS2017----------------------------------------------------------------------------
# Identify variable differences between dfs
compare_df_cols(PLS, PLS2017, return = c("mismatch"), bind_method = c("rbind"))
# Remove discontinued cols
PLS <- select(PLS, -ADDRTYPE, -LOCALE, -MSTATUS, -REAPLOCALE, -SCORE)
# Add new cols to PLS
PLS <- mutate(PLS,
              GEOMATCH = as.factor(NA),
              LOCALE_ADD = as.integer(NA),
              REAPLOCALE_ADD = as.integer(NA))
# Change type on cols for PLS2017
PLS2017 <- mutate(PLS2017,
                  CDCODE = as.factor(CDCODE),
                  LOCALE_MOD = as.factor(LOCALE_MOD),
                  PHONE = as.factor(PHONE))
# Vertical merge
PLS <- rbind(PLS, PLS2017)
```

## Variable Categories

After reviewing the 2007 and 2017 documentation and the criteria used by the Library Journal rating system, I have determined that the following variable categories will be assessed for this analysis and eventual dashboard development:

- Service outlets
- Operating revenue
- Collection expenditures
- Library collection
- Library services
- Circulation of materials
- Library programs
- Electronic technology

We are most interested in assessing how different library characteristics (ie: geographic location, population, urban status), library collection, available resources to patrons, and sources of operating revenue affect library usage. We are also interested in any trends over the 10-year period 2007 to 2017. 

### Identification

- `FSCSKEY`: Library identification code (unique)
- `LIBNAME`: Library name (for administrative entity)

### Location Characteristics

- `POPU LSA`: Population of the legal service area
- `C_LEGBAS`: Legal basis code (ie: city/county, municipal govt, etc.)
- `LOCALE_MOD`: Urban-centric locale code based on the modal locale of central and branch libraries
  - 11: City, Large
  - 12: City, Mid-Size
  - 13: City, Small
  - 21: Suburb, Large
  - 22: Suburb, Mid-Size
  - 23: Suburb, Small
  - 31: Town, Fringe
  - 32: Town, Distant
  - 33: Town, Remote
  - 41: Rural, Fringe
  - 42: Rural, Distant
  - 43: Rural, Remote

### Geography

- `STABR`: State code, two-letter
- `CITY`: City or town (for administrative entity)
- `ZIP`: Five-digit zip code
- `CNTY`: County
- `OBEREG`: Region
  - 1: New England
  - 2: Mid East
  - 3: Great Lakes
  - 4: Plains
  - 5: Southeast
  - 6: Southwest
  - 7: Rocky Mountaints
  - 8: Far West
  - 9: Outlying Areas
- `LONGITUD`: Longitude of location
- `LATITUDE`: Latitude of location

### Service Outlets

- `CENTLIB`: Number of central libraries
- `BRANLIB`: Number of branch libraries
- `BKMOB`: Number of bookmobiles
- `LIBRARIA`: Number of FTE employees with title of librarian

### Operating Revenue

- `LOCGVT`: Operating revenue from local government
- `STGVT`: Operating revenue from state government
- `FEDGVT`: Operating revenue from federal government
- `OTHINCM`: Other operating revenue

### Operating Expenditures

- `STAFFEXP`: Total staff expenditures, `SALARIES` + `BENEFIT`
**Collection Expenditures**
- `PRMATEXP`: Operating expenditures for print materials
- `ELMATEXP`: Operating expenditures for electronic materials
- `OTHMATEX`: Operating expenditures for all other library materials
- `TOTEXPCO`: Total expenditures on library collection
**Other Operating Expenditures**
- `OTHOPEXP`: Other operating expenditures
- `TOTOPEXP`: Total operating expenditures, `STAFFEXP`+`TOTEXPCO`+`OTHOPEXP`

### Library Collection

- `BKVOL`: Print materials
- `EBOOK`: Electronic books
- `AUDIO_PH`: Audio materials (physical)
- `AUDIO_DL`: Downloadable audio units
- `VIDEO_PH`: Video materials (physical)
- `VIDEO_DL`: Downloadable video units
- `ELECCOLL`: Total electronic collections

### Library Services

- `VISITS`: Total annual library visits
- `REGBOR`: Registered borrowers

### Circulation

- `TOTCIR`: Total annual circulation transactions
- `KIDCIRCL`: Total annual circulation of all children's materials
- `ELMATCIR`: Eletronic material circulation
- `PHYSCIR`: Total annual physical material circulation

### Inter-Library Loans
- `LOANTO`: Total annual loans provided to other libraries
- `LOANFM`: Total annual loans received from other libraries

### Library Programs
- `TOTPRO`: Total library programs
- `KIDPRO`: Total children's programs
- `YAPRO`: Total Young Adult Programs
- `TOTATTEN`: Total audience at all library programs
- `KIDATTEN`: Total audience at all children's programs
- `YAATTEN`: Young adult program attendance

### Electronic Technology
- `GPTERMS`: Internet terminals used by general public
- `PITUSR`: Users of public internet computers per year
- `WIFISESS`: Total annual wireless sessions provided by the library

## Data Tidying
```{r}
# Create Unique Identifier
PLS <- mutate(PLS, ID = as.character(paste(FSCSKEY, SRVY_YEAR, sep = "-")))
# Check for duplicate values on unique identifier
sum(duplicated(PLS$ID))
# Replace values of -1 with NA (-1: missing)
PLS[PLS == -1] <- NA
# Replace values of -3 with NA (-3: closed or temporary closed administrative entity)
PLS[PLS == -3] <- NA
# Replace values of -9 with NA (-9: data suppressed to protect confidentiality)
PLS[PLS == -9] <- NA
```

Replace factor variable numbers with text:
```{r}
# Replace OBEREG number codes with region names
PLS <- mutate(PLS, OBEREG = as.factor(ifelse(1, "New England",
                                           ifelse(2, "Mid East",
                                                  ifelse(3, "Great Lakes",
                                                         ifelse(4, "Plains",
                                                                ifelse(5, "Southeast",
                                                                       ifelse(6, "Southwest",
                                                                              ifelse(7,"Rocky Mountains",
                                                                                     ifelse(8, "Far West", "Outlying Areas")
                                                                                     )
                                                                              )
                                                                       )
                                                                )
                                                         )
                                                  )
                                           )
                                      )
              )
# Replace LOCALE_MOD number codes with locale names
PLS <- mutate(PLS, LOCALE_MOD = as.factor(ifelse(11, "City, Large",
                                                 ifelse(12, "City, Mid-Size",
                                                        ifelse(13, "City, Small",
                                                               ifelse(21, "Suburb, Large",
                                                                      ifelse(22, "Suburb, Mid_Size",
                                                                             ifelse(23, "Suburb, Small",
                                                                                    ifelse(31, "Town, Fringe",
                                                                                           ifelse(32, "Town, Distant",
                                                                                                  ifelse(33, "Town, Remote",
                                                                                                         ifelse(41, "Rural, Fringe",
                                                                                                                ifelse(42, "Rural, Distant", "Rural, Remote")
                                                                                                                )
                                                                                                         )
                                                                                                  )
                                                                                           )
                                                                                    )
                                                                             )
                                                                      )
                                                               )
                                                        )
                                                 )
                                          )
              )
# Replace C_LEGBAS number codes with legal basis names

```

Select Variables:
```{r}
# Select variables to focus on for final analysis

```

Examine Data Structure:
```{r}
# Examine data structure of PLS
# str(PLS)
```

Additional tidying notes:
- Use proper case on library name (for interactive dashboard searching)
- Replace integer values for `OBEREG` with string values using following key:
- Add variable for total locations: `CENTLIB` + `BRANLIB` + `BKMOB`
- Add variables showing the proportion of each operating revenue type
- Add variables showing the proportion of each collection expenditure type
- Add proportion of `KIDATTEN`

## First 10 Rows

# Univariate Non-Graphical Analysis

# Univariate Graphical Analysis

# Multivariate Non-Graphical Analysis

# Multivariate Graphical Analysis

# Detailed EDA

# Statistical Tests

# Regression Analysis

# Findings

```{r}
# Save PLS and PLS_final to csv for use in Tableau and other dashboard creation software
```

